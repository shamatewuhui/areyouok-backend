# 数据库初始化说明

## 问题说明

如果遇到 `mysql: command not found` 或数据库连接错误，说明当前环境无法直接访问数据库服务器（数据库可能在 Kubernetes 集群中）。

## 解决方案

### 方案一：使用 Node.js 脚本初始化（推荐）

项目已提供 Node.js 初始化脚本，无需安装 MySQL 客户端：

```bash
npm run init-db
```

**注意**：如果数据库在 Kubernetes 集群中且当前环境无法直接访问，请使用其他方案。

### 方案二：通过 kubectl 在集群内执行

如果数据库在 Kubernetes 集群中，可以通过 kubectl 执行：

```bash
# 方式1：通过 kubectl exec 执行
kubectl exec -it <mysql-pod-name> -n <namespace> -- mysql -u root -p4prw5sqx < 项目文件/数据库初始化脚本.sql

# 方式2：将SQL文件复制到Pod中执行
kubectl cp 项目文件/数据库初始化脚本.sql <namespace>/<mysql-pod-name>:/tmp/init.sql
kubectl exec -it <mysql-pod-name> -n <namespace> -- mysql -u root -p4prw5sqx < /tmp/init.sql
```

### 方案三：使用数据库管理工具

使用数据库管理工具（如 DBeaver、Navicat、MySQL Workbench）连接数据库并执行SQL文件：

1. 连接信息：
   - 主机：`areyouok-mysql-mysql.ns-smjizehq.svc`
   - 端口：`3306`
   - 用户名：`root`
   - 密码：`4prw5sqx`
   - 数据库：`jun_an_fou`（如果不存在，先创建）

2. 执行SQL文件：打开 `项目文件/数据库初始化脚本.sql` 并执行

### 方案四：确认数据库已初始化

如果数据库已经初始化过，可以跳过此步骤，直接启动应用测试连接：

```bash
npm start
# 或
npm run dev
```

查看控制台输出，如果显示"数据库连接成功"，说明数据库已配置正确。

## 验证数据库初始化

启动应用后，检查控制台输出：

- ✅ **成功**：`数据库连接成功`
- ❌ **失败**：`数据库连接失败: [错误信息]`

如果连接成功，说明数据库已正确初始化。

## 手动验证表结构

如果能够连接到数据库，可以执行以下SQL验证表是否已创建：

```sql
USE jun_an_fou;

-- 查看所有表
SHOW TABLES;

-- 应该看到以下表：
-- T_USER
-- T_SIGN_RECORD
-- T_EMAIL_NOTIFY

-- 查看表结构
DESC T_USER;
DESC T_SIGN_RECORD;
DESC T_EMAIL_NOTIFY;
```

## 常见问题

### 1. 连接被拒绝（ECONNREFUSED / EPERM）

**原因**：数据库在 Kubernetes 集群中，当前环境无法直接访问

**解决**：使用方案二（kubectl）或方案三（数据库管理工具）

### 2. 数据库已存在错误

**原因**：数据库已经创建

**解决**：脚本会自动处理，继续创建表结构。如果表也已存在，可以手动删除后重新执行，或直接使用现有数据库。

### 3. 表已存在错误

**原因**：表结构已经创建

**解决**：如果表已存在且结构正确，无需重新初始化。可以继续使用。

## 下一步

数据库初始化完成后，可以：

1. 启动应用：`npm start` 或 `npm run dev`
2. 测试接口：使用 Postman 或 curl 测试 API 接口
3. 查看日志：确认数据库连接和邮件服务配置正常
