# 核心表结构详解

## 2.1 Process 模块（流水线核心）

### 流水线信息表

```sql
-- T_PIPELINE_INFO：流水线基本信息
CREATE TABLE T_PIPELINE_INFO (
  PIPELINE_ID varchar(34) PRIMARY KEY,
  PROJECT_ID varchar(64) NOT NULL,
  PIPELINE_NAME varchar(255) NOT NULL,
  VERSION int(11) DEFAULT 1,
  CHANNEL varchar(32),
  CREATOR varchar(64) NOT NULL,
  CREATE_TIME timestamp NOT NULL,
  LAST_MODIFY_USER varchar(64) NOT NULL,
  UPDATE_TIME timestamp,
  `DELETE` bit(1) DEFAULT b'0',
  LOCKED bit(1) DEFAULT b'0',
  UNIQUE KEY (PROJECT_ID, PIPELINE_NAME)
);

-- T_PIPELINE_RESOURCE：流水线编排资源
CREATE TABLE T_PIPELINE_RESOURCE (
  PROJECT_ID varchar(64) NOT NULL,
  PIPELINE_ID varchar(34) NOT NULL,
  VERSION int(11) NOT NULL DEFAULT 1,
  MODEL mediumtext,
  YAML mediumtext,
  CREATOR varchar(64),
  CREATE_TIME timestamp NOT NULL,
  PRIMARY KEY (PIPELINE_ID, VERSION)
);

-- T_PIPELINE_SETTING：流水线配置
CREATE TABLE T_PIPELINE_SETTING (
  PIPELINE_ID varchar(34) PRIMARY KEY,
  PROJECT_ID varchar(64),
  NAME varchar(255),
  RUN_LOCK_TYPE int(11) DEFAULT 1,
  WAIT_QUEUE_TIME_SECOND int(11) DEFAULT 7200,
  MAX_QUEUE_SIZE int(11) DEFAULT 10,
  CONCURRENCY_GROUP varchar(255),
  BUILD_NUM_RULE varchar(512),
  SUCCESS_SUBSCRIPTION text,
  FAILURE_SUBSCRIPTION text
);
```

### 构建历史表

```sql
-- T_PIPELINE_BUILD_HISTORY：构建历史（核心表）
CREATE TABLE T_PIPELINE_BUILD_HISTORY (
  BUILD_ID varchar(34) PRIMARY KEY,
  PROJECT_ID varchar(64) NOT NULL,
  PIPELINE_ID varchar(34) NOT NULL,
  BUILD_NUM int(20) DEFAULT 0,
  VERSION int(11),
  STATUS int(11),
  START_USER varchar(64),
  TRIGGER varchar(32) NOT NULL,
  TRIGGER_USER varchar(64),
  START_TIME timestamp,
  END_TIME timestamp,
  EXECUTE_TIME bigint(20),
  MATERIAL mediumtext,
  BUILD_PARAMETERS mediumtext,
  ERROR_TYPE int(11),
  ERROR_CODE int(11),
  ERROR_MSG text,
  KEY STATUS_KEY (PROJECT_ID, PIPELINE_ID, STATUS),
  KEY INX_PROJECT_PIPELINE_NUM (PROJECT_ID, PIPELINE_ID, BUILD_NUM),
  KEY INX_PROJECT_PIPELINE_START_TIME (PROJECT_ID, PIPELINE_ID, START_TIME),
  KEY inx_status (STATUS),
  KEY inx_start_time (START_TIME)
);

-- T_PIPELINE_BUILD_SUMMARY：构建摘要
CREATE TABLE T_PIPELINE_BUILD_SUMMARY (
  PIPELINE_ID varchar(34) PRIMARY KEY,
  PROJECT_ID varchar(64) NOT NULL,
  BUILD_NUM int(11) DEFAULT 0,
  FINISH_COUNT int(11) DEFAULT 0,
  RUNNING_COUNT int(11) DEFAULT 0,
  QUEUE_COUNT int(11) DEFAULT 0,
  LATEST_BUILD_ID varchar(34),
  LATEST_STATUS int(11),
  LATEST_START_TIME timestamp,
  LATEST_END_TIME timestamp
);
```

### 构建任务表

```sql
-- T_PIPELINE_BUILD_TASK：构建任务详情
CREATE TABLE T_PIPELINE_BUILD_TASK (
  BUILD_ID varchar(34) NOT NULL,
  TASK_ID varchar(34) NOT NULL,
  PROJECT_ID varchar(64) NOT NULL,
  PIPELINE_ID varchar(34) NOT NULL,
  STAGE_ID varchar(34) NOT NULL,
  CONTAINER_ID varchar(34) NOT NULL,
  TASK_NAME varchar(128),
  TASK_TYPE varchar(64) NOT NULL,
  TASK_ATOM varchar(128),
  ATOM_CODE varchar(128),
  STATUS int(11),
  START_TIME timestamp,
  END_TIME timestamp,
  EXECUTE_COUNT int(11) DEFAULT 0,
  ERROR_TYPE int(11),
  ERROR_CODE int(11),
  ERROR_MSG text,
  TASK_PARAMS mediumtext,
  PRIMARY KEY (BUILD_ID, TASK_ID),
  KEY PROJECT_PIPELINE (PROJECT_ID, PIPELINE_ID)
);

-- T_PIPELINE_BUILD_STAGE：构建阶段
CREATE TABLE T_PIPELINE_BUILD_STAGE (
  BUILD_ID varchar(64) NOT NULL,
  STAGE_ID varchar(64) NOT NULL,
  PROJECT_ID varchar(64) NOT NULL,
  PIPELINE_ID varchar(64) NOT NULL,
  SEQ int(11) NOT NULL,
  STATUS int(11),
  START_TIME timestamp,
  END_TIME timestamp,
  CHECK_IN mediumtext,
  CHECK_OUT mediumtext,
  PRIMARY KEY (BUILD_ID, STAGE_ID)
);

-- T_PIPELINE_BUILD_CONTAINER：构建容器
CREATE TABLE T_PIPELINE_BUILD_CONTAINER (
  BUILD_ID varchar(64) NOT NULL,
  STAGE_ID varchar(64) NOT NULL,
  CONTAINER_ID varchar(64) NOT NULL,
  PROJECT_ID varchar(64) NOT NULL,
  PIPELINE_ID varchar(64) NOT NULL,
  CONTAINER_TYPE varchar(45),
  SEQ int(11) NOT NULL,
  STATUS int(11),
  MATRIX_GROUP_FLAG BIT(1),
  MATRIX_GROUP_ID varchar(64),
  JOB_ID varchar(128),
  PRIMARY KEY (BUILD_ID, STAGE_ID, CONTAINER_ID)
);

-- T_PIPELINE_BUILD_VAR：构建变量
CREATE TABLE T_PIPELINE_BUILD_VAR (
  BUILD_ID varchar(34) NOT NULL,
  `KEY` varchar(255) NOT NULL,
  `VALUE` varchar(4000),
  PROJECT_ID varchar(64),
  PIPELINE_ID varchar(64),
  VAR_TYPE VARCHAR(64),
  READ_ONLY bit(1),
  PRIMARY KEY (BUILD_ID, `KEY`)
);
```

### 构建执行记录表（RECORD 系列）

> **重要**: BUILD 系列用于引擎执行调度，RECORD 系列用于前端展示和历史查询。RECORD 通过 `EXECUTE_COUNT` 支持同一构建的多次重试记录。

```sql
-- T_PIPELINE_BUILD_RECORD_MODEL
CREATE TABLE T_PIPELINE_BUILD_RECORD_MODEL (
  BUILD_ID varchar(34) NOT NULL,
  PROJECT_ID varchar(64) NOT NULL,
  PIPELINE_ID varchar(34) NOT NULL,
  RESOURCE_VERSION int(11) NOT NULL,
  BUILD_NUM int(20) NOT NULL,
  EXECUTE_COUNT int(11) NOT NULL,
  START_USER varchar(32) NOT NULL,
  MODEL_VAR mediumtext NOT NULL,
  START_TYPE varchar(32) NOT NULL,
  QUEUE_TIME datetime(3) NOT NULL,
  START_TIME datetime(3) NULL,
  END_TIME datetime(3) NULL,
  STATUS varchar(32),
  ERROR_INFO text,
  CANCEL_USER varchar(32),
  TIMESTAMPS text,
  PRIMARY KEY (BUILD_ID, EXECUTE_COUNT)
);

-- T_PIPELINE_BUILD_RECORD_STAGE
CREATE TABLE T_PIPELINE_BUILD_RECORD_STAGE (
  BUILD_ID varchar(64) NOT NULL,
  PROJECT_ID varchar(64) NOT NULL,
  PIPELINE_ID varchar(64) NOT NULL,
  RESOURCE_VERSION int(11),
  STAGE_ID varchar(64) NOT NULL,
  SEQ int(11) NOT NULL,
  STAGE_VAR text NOT NULL,
  STATUS varchar(32),
  EXECUTE_COUNT int(11) NOT NULL DEFAULT 1,
  START_TIME datetime(3) NULL,
  END_TIME datetime(3) NULL,
  TIMESTAMPS text,
  PRIMARY KEY (BUILD_ID, STAGE_ID, EXECUTE_COUNT)
);

-- T_PIPELINE_BUILD_RECORD_CONTAINER
CREATE TABLE T_PIPELINE_BUILD_RECORD_CONTAINER (
  BUILD_ID varchar(64) NOT NULL,
  PROJECT_ID varchar(64) NOT NULL,
  PIPELINE_ID varchar(64) NOT NULL,
  RESOURCE_VERSION int(11) NOT NULL,
  STAGE_ID varchar(64) NOT NULL,
  CONTAINER_ID varchar(64) NOT NULL,
  EXECUTE_COUNT int(11) NOT NULL DEFAULT 1,
  STATUS varchar(32),
  CONTAINER_VAR mediumtext NOT NULL,
  CONTAINER_TYPE varchar(45),
  CONTAIN_POST_TASK bit(1),
  MATRIX_GROUP_FLAG bit(1),
  MATRIX_GROUP_ID varchar(64),
  START_TIME datetime(3) NULL,
  END_TIME datetime(3) NULL,
  TIMESTAMPS text,
  PRIMARY KEY (BUILD_ID, CONTAINER_ID, EXECUTE_COUNT)
);

-- T_PIPELINE_BUILD_RECORD_TASK
CREATE TABLE T_PIPELINE_BUILD_RECORD_TASK (
  BUILD_ID varchar(34) NOT NULL,
  PROJECT_ID varchar(64) NOT NULL,
  PIPELINE_ID varchar(34) NOT NULL,
  RESOURCE_VERSION int(11) NOT NULL,
  STAGE_ID varchar(34) NOT NULL,
  CONTAINER_ID varchar(34) NOT NULL,
  TASK_ID varchar(34) NOT NULL,
  TASK_SEQ int(11) NOT NULL DEFAULT 1,
  EXECUTE_COUNT int(11) NOT NULL DEFAULT 1,
  STATUS varchar(32),
  TASK_VAR mediumtext NOT NULL,
  POST_INFO text,
  CLASS_TYPE varchar(64) NOT NULL,
  ATOM_CODE varchar(128) NOT NULL,
  ORIGIN_CLASS_TYPE varchar(64),
  START_TIME datetime(3) NULL,
  END_TIME datetime(3) NULL,
  TIMESTAMPS text,
  ASYNC_STATUS varchar(32),
  PRIMARY KEY (BUILD_ID, TASK_ID, EXECUTE_COUNT)
);
```

**BUILD vs RECORD 使用场景**:

| 场景 | BUILD 表 | RECORD 表 |
|------|---------|-----------|
| 引擎调度执行 | ✅ | ❌ |
| Worker 拉取任务 | ✅ | ❌ |
| 前端构建详情页 | ❌ | ✅ |
| 查看历史执行记录 | ❌ | ✅ |
| 重试时保留历史 | ❌ 覆盖 | ✅ 新增 |

### 模板相关表

```sql
-- T_TEMPLATE：流水线模板
CREATE TABLE T_TEMPLATE (
  VERSION bigint(20) AUTO_INCREMENT,
  ID varchar(32) NOT NULL,
  TEMPLATE_NAME varchar(64) NOT NULL,
  PROJECT_ID varchar(34) NOT NULL,
  VERSION_NAME varchar(64) NOT NULL,
  TEMPLATE mediumtext,
  TYPE varchar(32) DEFAULT 'CUSTOMIZE',
  STORE_FLAG bit(1) DEFAULT b'0',
  PRIMARY KEY (VERSION),
  KEY ID (ID)
);

-- T_TEMPLATE_PIPELINE：模板实例关联
CREATE TABLE T_TEMPLATE_PIPELINE (
  PIPELINE_ID varchar(34) PRIMARY KEY,
  PROJECT_ID varchar(64) NOT NULL,
  TEMPLATE_ID varchar(32) NOT NULL,
  VERSION bigint(20) NOT NULL,
  INSTANCE_TYPE VARCHAR(32) DEFAULT 'CONSTRAINT',
  PARAM mediumtext,
  STATUS varchar(32) DEFAULT 'UPDATED'
);
```

## 2.2 Project 模块（项目管理）

```sql
-- T_PROJECT：项目信息
CREATE TABLE T_PROJECT (
  ID bigint(20) AUTO_INCREMENT,
  PROJECT_ID varchar(32) NOT NULL,
  project_name varchar(64) NOT NULL,
  english_name varchar(64) NOT NULL,
  creator varchar(32),
  description text,
  is_offlined bit(1) DEFAULT b'0',
  bg_id bigint(20),
  bg_name varchar(255),
  dept_id bigint(20),
  dept_name varchar(255),
  center_id bigint(20),
  center_name varchar(255),
  approval_status int(10) DEFAULT 1,
  CHANNEL varchar(32) DEFAULT 'BS',
  pipeline_limit int(10) DEFAULT 500,
  router_tag varchar(32),
  properties text,
  PRIMARY KEY (ID),
  UNIQUE KEY project_name (project_name),
  UNIQUE KEY project_id (PROJECT_ID),
  UNIQUE KEY english_name (english_name)
);

-- T_SERVICE：服务信息
CREATE TABLE T_SERVICE (
  id bigint(20) AUTO_INCREMENT PRIMARY KEY,
  name varchar(64),
  english_name varchar(64),
  service_type_id bigint(20),
  link varchar(255),
  status varchar(64),
  UNIQUE KEY service_name (name)
);

-- T_SHARDING_ROUTING_RULE：分片路由规则
CREATE TABLE T_SHARDING_ROUTING_RULE (
  ID varchar(32) PRIMARY KEY,
  ROUTING_NAME varchar(128) NOT NULL,
  ROUTING_RULE varchar(256) NOT NULL,
  CLUSTER_NAME varchar(64) DEFAULT 'prod',
  MODULE_CODE varchar(64) DEFAULT 'PROCESS',
  TYPE varchar(32) DEFAULT 'DB',
  DATA_SOURCE_NAME varchar(128) DEFAULT 'ds_0'
);
```

## 2.3 Auth 模块（权限认证）

```sql
-- T_AUTH_RESOURCE：资源表
CREATE TABLE T_AUTH_RESOURCE (
  ID bigint(20) AUTO_INCREMENT PRIMARY KEY,
  PROJECT_CODE varchar(32) NOT NULL,
  RESOURCE_TYPE varchar(32) NOT NULL,
  RESOURCE_CODE varchar(255) NOT NULL,
  RESOURCE_NAME varchar(255) NOT NULL,
  IAM_RESOURCE_CODE varchar(32) NOT NULL,
  ENABLE bit(1) DEFAULT b'0',
  RELATION_ID varchar(32) NOT NULL,
  UNIQUE KEY IDX_PROJECT_RESOURCE (PROJECT_CODE, RESOURCE_TYPE, RESOURCE_CODE)
);

-- T_AUTH_RESOURCE_GROUP：资源用户组
CREATE TABLE T_AUTH_RESOURCE_GROUP (
  ID bigint(20) AUTO_INCREMENT PRIMARY KEY,
  PROJECT_CODE varchar(32) NOT NULL,
  RESOURCE_TYPE varchar(32) NOT NULL,
  RESOURCE_CODE varchar(255) NOT NULL,
  GROUP_CODE varchar(32) NOT NULL,
  GROUP_NAME varchar(255) NOT NULL,
  DEFAULT_GROUP bit(1) DEFAULT b'1',
  RELATION_ID varchar(32) NOT NULL,
  UNIQUE KEY (PROJECT_CODE, RESOURCE_TYPE, RESOURCE_CODE, GROUP_NAME)
);

-- T_AUTH_RESOURCE_GROUP_MEMBER：用户组成员
CREATE TABLE T_AUTH_RESOURCE_GROUP_MEMBER (
  ID bigint AUTO_INCREMENT PRIMARY KEY,
  PROJECT_CODE varchar(64) NOT NULL,
  RESOURCE_TYPE varchar(32) NOT NULL,
  RESOURCE_CODE varchar(255) NOT NULL,
  GROUP_CODE varchar(32) NOT NULL,
  IAM_GROUP_ID int(20) NOT NULL,
  MEMBER_ID varchar(64) NOT NULL,
  MEMBER_NAME varchar(512) NOT NULL,
  MEMBER_TYPE varchar(32) NOT NULL,
  EXPIRED_TIME datetime NOT NULL,
  UNIQUE KEY (PROJECT_CODE, IAM_GROUP_ID, MEMBER_ID)
);

-- T_AUTH_ACTION：权限操作表
CREATE TABLE T_AUTH_ACTION (
  ACTION varchar(64) PRIMARY KEY,
  RESOURCE_TYPE varchar(64) NOT NULL,
  ACTION_NAME varchar(64) NOT NULL,
  ACTION_TYPE varchar(32)
);
```

## 2.4 Store 模块（研发商店）

```sql
-- T_ATOM：插件信息
CREATE TABLE T_ATOM (
  ID varchar(32) PRIMARY KEY,
  NAME varchar(64) NOT NULL,
  ATOM_CODE varchar(64) NOT NULL,
  CLASS_TYPE varchar(64) NOT NULL,
  VERSION varchar(30) NOT NULL,
  ATOM_STATUS tinyint(4) NOT NULL,
  ATOM_TYPE tinyint(4) DEFAULT 1,
  OS varchar(100) NOT NULL,
  CLASSIFY_ID varchar(32) NOT NULL,
  LATEST_FLAG bit(1) NOT NULL,
  DEFAULT_FLAG bit(1) DEFAULT b'0',
  PUBLISHER varchar(50) DEFAULT 'system',
  PROPS text,
  UNIQUE KEY (ATOM_CODE, VERSION),
  KEY inx_atom_status (ATOM_STATUS),
  KEY inx_latest_flag (LATEST_FLAG)
);

-- T_ATOM_ENV_INFO：插件执行环境
CREATE TABLE T_ATOM_ENV_INFO (
  ID varchar(32) PRIMARY KEY,
  ATOM_ID varchar(32) NOT NULL,
  PKG_PATH varchar(1024) NOT NULL,
  LANGUAGE varchar(64),
  TARGET varchar(256) NOT NULL,
  OS_NAME varchar(128),
  OS_ARCH varchar(128),
  RUNTIME_VERSION varchar(128),
  DEFAULT_FLAG bit(1) DEFAULT b'1',
  UNIQUE KEY (ATOM_ID, OS_NAME, OS_ARCH)
);

-- T_STORE_PROJECT_REL：商店组件与项目关联
CREATE TABLE T_STORE_PROJECT_REL (
  ID varchar(32) PRIMARY KEY,
  STORE_CODE varchar(64) NOT NULL,
  PROJECT_CODE varchar(64) NOT NULL,
  TYPE tinyint(4) NOT NULL,
  STORE_TYPE tinyint(4) DEFAULT 0,
  INSTANCE_ID varchar(64) DEFAULT '',
  CREATOR varchar(64) DEFAULT '',
  UNIQUE KEY (STORE_CODE, STORE_TYPE, PROJECT_CODE, TYPE, INSTANCE_ID, CREATOR)
);

-- T_STORE_STATISTICS_TOTAL：统计信息
CREATE TABLE T_STORE_STATISTICS_TOTAL (
  ID varchar(32) PRIMARY KEY,
  STORE_CODE varchar(64) NOT NULL,
  STORE_TYPE tinyint(4) DEFAULT 0,
  DOWNLOADS int(11) DEFAULT 0,
  COMMITS int(11) DEFAULT 0,
  SCORE int(11) DEFAULT 0,
  SCORE_AVERAGE decimal(3,1) DEFAULT 0.0,
  PIPELINE_NUM INT(11) DEFAULT 0,
  UNIQUE KEY (STORE_CODE, STORE_TYPE)
);
```

## 2.5 Repository 模块（代码库）

```sql
-- T_REPOSITORY：代码库信息
CREATE TABLE T_REPOSITORY (
  REPOSITORY_ID bigint(20) AUTO_INCREMENT PRIMARY KEY,
  PROJECT_ID varchar(32) NOT NULL,
  USER_ID varchar(64) NOT NULL,
  ALIAS_NAME varchar(255) NOT NULL,
  URL varchar(255) NOT NULL,
  TYPE varchar(20) NOT NULL,
  REPOSITORY_HASH_ID varchar(64),
  IS_DELETED bit(1) NOT NULL,
  ENABLE_PAC bit(1) DEFAULT false,
  KEY PROJECT_ID (PROJECT_ID),
  KEY inx_alias_name (ALIAS_NAME)
);

-- T_REPOSITORY_CODE_GIT：Git代码库详情
CREATE TABLE T_REPOSITORY_CODE_GIT (
  REPOSITORY_ID bigint(20) PRIMARY KEY,
  PROJECT_NAME varchar(255) NOT NULL,
  USER_NAME varchar(64) NOT NULL,
  CREDENTIAL_ID varchar(64) NOT NULL,
  AUTH_TYPE varchar(8),
  GIT_PROJECT_ID bigint(20) DEFAULT 0
);

-- T_REPOSITORY_COMMIT：提交记录
CREATE TABLE T_REPOSITORY_COMMIT (
  ID bigint(20) AUTO_INCREMENT PRIMARY KEY,
  BUILD_ID varchar(34),
  PIPELINE_ID varchar(34),
  REPO_ID bigint(20),
  TYPE smallint(6),
  COMMIT varchar(64),
  COMMITTER varchar(32),
  COMMIT_TIME datetime,
  COMMENT longtext,
  KEY IDX_BUILD_ID_TIME (BUILD_ID, COMMIT_TIME)
);
```

## 2.6 Dispatch 模块（构建调度）

```sql
-- T_DISPATCH_THIRDPARTY_AGENT_BUILD：第三方构建机任务
CREATE TABLE T_DISPATCH_THIRDPARTY_AGENT_BUILD (
  ID bigint(20) AUTO_INCREMENT PRIMARY KEY,
  PROJECT_ID varchar(64) NOT NULL,
  AGENT_ID varchar(32) NOT NULL,
  PIPELINE_ID varchar(34) NOT NULL,
  BUILD_ID varchar(34) NOT NULL,
  VM_SEQ_ID varchar(34) NOT NULL,
  STATUS int(11) NOT NULL,
  WORKSPACE varchar(4096),
  NODE_ID bigint(20) DEFAULT 0,
  DOCKER_INFO json,
  UNIQUE KEY (BUILD_ID, VM_SEQ_ID),
  KEY idx_agent_id (AGENT_ID),
  KEY idx_status (STATUS)
);

-- T_DISPATCH_RUNNING_JOBS：运行中的任务
CREATE TABLE T_DISPATCH_RUNNING_JOBS (
  ID int(20) AUTO_INCREMENT PRIMARY KEY,
  PROJECT_ID varchar(128) NOT NULL,
  VM_TYPE varchar(128) NOT NULL,
  CHANNEL_CODE varchar(128) DEFAULT 'BS',
  BUILD_ID varchar(128) NOT NULL,
  VM_SEQ_ID varchar(128) NOT NULL,
  EXECUTE_COUNT int(11) NOT NULL,
  CREATED_TIME datetime NOT NULL,
  AGENT_START_TIME datetime,
  KEY inx_project_id (PROJECT_ID, VM_TYPE, CHANNEL_CODE),
  KEY inx_build_id (BUILD_ID)
);

-- T_DISPATCH_QUOTA_PROJECT：项目配额
CREATE TABLE T_DISPATCH_QUOTA_PROJECT (
  PROJECT_ID varchar(128) NOT NULL,
  VM_TYPE varchar(128) NOT NULL,
  CHANNEL_CODE varchar(128) DEFAULT 'BS',
  RUNNING_JOBS_MAX int(10) NOT NULL,
  RUNNING_TIME_JOB_MAX int(10) NOT NULL,
  RUNNING_TIME_PROJECT_MAX int(10) NOT NULL,
  PRIMARY KEY (PROJECT_ID, VM_TYPE, CHANNEL_CODE)
);
```

## 2.7 Environment 模块（构建机环境）

```sql
-- T_NODE：节点信息
CREATE TABLE T_NODE (
  NODE_ID bigint(20) AUTO_INCREMENT PRIMARY KEY,
  PROJECT_ID varchar(64) NOT NULL,
  NODE_IP varchar(64) NOT NULL,
  NODE_NAME varchar(64) NOT NULL,
  NODE_STATUS varchar(64) NOT NULL,
  NODE_TYPE varchar(64) NOT NULL,
  OS_NAME varchar(128),
  DISPLAY_NAME varchar(128) DEFAULT '',
  PIPELINE_REF_COUNT int(11) DEFAULT 0,
  LAST_BUILD_TIME datetime,
  KEY PROJECT_ID (PROJECT_ID),
  KEY NODE_IP (NODE_IP)
);

-- T_ENVIRONMENT_THIRDPARTY_AGENT：第三方构建机
CREATE TABLE T_ENVIRONMENT_THIRDPARTY_AGENT (
  ID bigint(20) AUTO_INCREMENT PRIMARY KEY,
  NODE_ID bigint(20),
  PROJECT_ID varchar(64) NOT NULL,
  HOSTNAME varchar(128) DEFAULT '',
  IP varchar(64) DEFAULT '',
  OS varchar(16) NOT NULL,
  STATUS int(11) NOT NULL,
  SECRET_KEY varchar(256) NOT NULL,
  VERSION varchar(128),
  PARALLEL_TASK_COUNT int(11),
  DOCKER_PARALLEL_TASK_COUNT int(11),
  KEY idx_agent_node (NODE_ID),
  KEY idx_agent_project (PROJECT_ID)
);

-- T_ENV：环境信息
CREATE TABLE T_ENV (
  ENV_ID bigint(20) AUTO_INCREMENT PRIMARY KEY,
  PROJECT_ID varchar(64) NOT NULL,
  ENV_NAME varchar(128) NOT NULL,
  ENV_TYPE varchar(128) NOT NULL,
  ENV_VARS text NOT NULL,
  IS_DELETED bit(1) NOT NULL,
  KEY PROJECT_ID (PROJECT_ID)
);

-- T_ENV_NODE：环境-节点关联
CREATE TABLE T_ENV_NODE (
  ENV_ID bigint(20) NOT NULL,
  NODE_ID bigint(20) NOT NULL,
  PROJECT_ID varchar(64) NOT NULL,
  ENABLE_NODE bit(1) DEFAULT 1,
  PRIMARY KEY (ENV_ID, NODE_ID)
);
```

## 分片与数据源表

```sql
-- T_DATA_SOURCE：数据源配置
CREATE TABLE T_DATA_SOURCE (
  ID varchar(32) PRIMARY KEY,
  CLUSTER_NAME varchar(64) NOT NULL,
  MODULE_CODE varchar(64) NOT NULL,
  DATA_SOURCE_NAME varchar(128) NOT NULL,
  FULL_FLAG bit(1) DEFAULT b'0',
  DS_URL varchar(1024),
  TAG varchar(128),
  TYPE varchar(32) DEFAULT 'DB'
);
```
