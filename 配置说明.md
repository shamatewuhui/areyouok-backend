# 君安否小程序 - 配置说明文档

## 一、环境变量配置

项目使用 `.env` 文件存储配置信息。请复制 `.env.example` 文件为 `.env` 并根据实际情况修改配置。

### 1.1 服务器配置

```env
# 服务器端口
PORT=3000

# 运行环境：development（开发环境）或 production（生产环境）
NODE_ENV=development
```

### 1.2 数据库配置

根据您提供的数据库配置信息，已设置如下：

```env
# 数据库主机地址
DB_HOST=areyouok-mysql-mysql.ns-smjizehq.svc

# 数据库端口
DB_PORT=3306

# 数据库用户名
DB_USER=root

# 数据库密码
DB_PASSWORD=4prw5sqx

# 数据库名称
DB_NAME=jun_an_fou
```

**注意**：请确保数据库已创建，并且已执行数据库初始化脚本（`项目文件/数据库初始化脚本.sql`）。

### 1.3 邮件服务配置

邮件服务配置是**必须的**，用于发送签到提醒邮件。以下是常见邮件服务商的配置示例：

#### 方式一：使用 QQ 邮箱

```env
# SMTP服务器地址
EMAIL_HOST=smtp.qq.com

# SMTP端口（QQ邮箱使用587端口，SSL使用465）
EMAIL_PORT=587

# 是否使用SSL（587端口使用false，465端口使用true）
EMAIL_SECURE=false

# 发送邮件的邮箱账号（完整的QQ邮箱地址）
EMAIL_USER=513082905@qq.com

# 邮箱授权码（不是QQ密码！需要在QQ邮箱设置中生成授权码）
EMAIL_PASSWORD=noitqiyreewiccfd

# 发件人显示名称和邮箱（可选，默认使用EMAIL_USER）
EMAIL_FROM=君安否 <your-qq@qq.com>
```

**QQ邮箱授权码获取步骤**：
1. 登录QQ邮箱
2. 点击"设置" -> "账户"
3. 找到"POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务"
4. 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
5. 点击"生成授权码"，按照提示发送短信后获得授权码
6. 将授权码填入 `EMAIL_PASSWORD`

#### 方式二：使用 163 邮箱

```env
EMAIL_HOST=smtp.163.com
EMAIL_PORT=465
EMAIL_SECURE=true
EMAIL_USER=your-email@163.com
EMAIL_PASSWORD=your-authorization-code
EMAIL_FROM=君安否 <your-email@163.com>
```

**163邮箱授权码获取步骤**：
1. 登录163邮箱
2. 点击"设置" -> "POP3/SMTP/IMAP"
3. 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
4. 点击"生成授权码"，按照提示发送短信后获得授权码
5. 将授权码填入 `EMAIL_PASSWORD`

#### 方式三：使用 Gmail

```env
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-password
EMAIL_FROM=君安否 <your-email@gmail.com>
```

**Gmail配置说明**：
1. 需要开启"两步验证"
2. 生成"应用专用密码"（App Password）
3. 将应用专用密码填入 `EMAIL_PASSWORD`

#### 方式四：使用企业邮箱（如腾讯企业邮箱）

```env
EMAIL_HOST=smtp.exmail.qq.com
EMAIL_PORT=465
EMAIL_SECURE=true
EMAIL_USER=your-email@your-domain.com
EMAIL_PASSWORD=your-password
EMAIL_FROM=君安否 <your-email@your-domain.com>
```

#### 方式五：使用其他SMTP服务

```env
# SMTP服务器地址（咨询您的邮件服务商）
EMAIL_HOST=smtp.example.com

# SMTP端口（通常是587或465）
EMAIL_PORT=587

# 是否使用SSL（587通常false，465通常true）
EMAIL_SECURE=false

# 邮箱账号
EMAIL_USER=your-email@example.com

# 邮箱密码或授权码
EMAIL_PASSWORD=your-password

# 发件人显示
EMAIL_FROM=君安否 <your-email@example.com>
```

### 1.4 邮件内容配置

```env
# 邮件主题
EMAIL_SUBJECT=我连续2天都不好，快给我打个电话吧！

# 邮件正文内容
EMAIL_CONTENT=我连续2天都不好，快给我打个电话吧！
```

**注意**：邮件内容可以根据需要自定义，支持纯文本格式。

### 1.5 定时任务配置

```env
# Cron表达式，定义邮件提醒任务的执行时间
# 默认：每天凌晨1点执行（0 1 * * *）
CRON_SCHEDULE=0 1 * * *
```

**Cron表达式说明**：
- `0 1 * * *`：每天凌晨1点执行
- `0 */6 * * *`：每6小时执行一次
- `0 0 * * *`：每天午夜执行
- `0 9,18 * * *`：每天上午9点和下午6点执行

**Cron表达式格式**：`分钟 小时 日 月 星期`

## 二、完整配置示例

以下是一个完整的 `.env` 文件示例（使用QQ邮箱）：

```env
# 服务器配置
PORT=3000
NODE_ENV=development

# 数据库配置
DB_HOST=areyouok-mysql-mysql.ns-smjizehq.svc
DB_PORT=3306
DB_USER=root
DB_PASSWORD=4prw5sqx
DB_NAME=jun_an_fou

# 邮件服务配置（QQ邮箱示例）
EMAIL_HOST=smtp.qq.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=your-qq@qq.com
EMAIL_PASSWORD=your-authorization-code
EMAIL_FROM=君安否 <your-qq@qq.com>

# 邮件内容配置
EMAIL_SUBJECT=我连续2天都不好，快给我打个电话吧！
EMAIL_CONTENT=我连续2天都不好，快给我打个电话吧！

# 定时任务配置（每天凌晨1点执行）
CRON_SCHEDULE=0 1 * * *
```

## 三、配置验证

### 3.1 数据库连接验证

启动应用后，控制台会输出数据库连接状态：
- 成功：`数据库连接成功`
- 失败：`数据库连接失败: [错误信息]`

### 3.2 邮件服务验证

启动应用后，控制台会输出邮件服务配置状态：
- 成功：`邮件服务配置成功`
- 失败：`邮件服务配置错误: [错误信息]`

### 3.3 手动测试邮件发送

可以创建一个测试脚本来验证邮件配置：

```javascript
// test-email.js
require('dotenv').config();
const { sendEmail } = require('./src/config/email');

async function testEmail() {
  const result = await sendEmail(
    'test@example.com', // 替换为您的测试邮箱
    '测试邮件',
    '这是一封测试邮件'
  );
  console.log('发送结果:', result);
}

testEmail();
```

运行测试：
```bash
node test-email.js
```

## 四、常见问题

### 4.1 邮件发送失败

**问题**：邮件发送失败，提示认证错误

**解决方案**：
1. 确认使用的是**授权码**而不是邮箱密码
2. 确认已开启SMTP服务
3. 检查 `EMAIL_SECURE` 配置是否正确（587端口通常为false，465端口通常为true）
4. 检查防火墙是否阻止了SMTP端口

### 4.2 数据库连接失败

**问题**：无法连接到数据库

**解决方案**：
1. 确认数据库服务已启动
2. 检查数据库配置信息是否正确
3. 确认数据库已创建（`jun_an_fou`）
4. 确认网络连接正常（如果是远程数据库）
5. 检查数据库用户权限

### 4.3 定时任务不执行

**问题**：定时任务没有按预期执行

**解决方案**：
1. 检查 `CRON_SCHEDULE` 配置是否正确
2. 确认服务器时区设置正确
3. 查看应用日志，确认任务是否已启动
4. 可以临时修改Cron表达式为每分钟执行一次进行测试：`* * * * *`

## 五、安全建议

1. **不要将 `.env` 文件提交到版本控制系统**
   - 确保 `.env` 在 `.gitignore` 中
   - 使用 `.env.example` 作为配置模板

2. **生产环境配置**
   - 使用强密码
   - 定期更换授权码
   - 限制数据库访问IP
   - 使用HTTPS（如果部署到生产环境）

3. **邮件服务安全**
   - 使用应用专用密码而不是账户密码
   - 定期更换授权码
   - 限制发送频率，避免被标记为垃圾邮件

## 六、部署说明

### 6.1 开发环境

1. 安装依赖：
```bash
npm install
```

2. 配置 `.env` 文件

3. 启动开发服务器：
```bash
npm run dev
```

### 6.2 生产环境

1. 安装依赖：
```bash
npm install --production
```

2. 配置 `.env` 文件（确保 `NODE_ENV=production`）

3. 启动生产服务器：
```bash
npm start
```

4. 建议使用 PM2 管理进程：
```bash
npm install -g pm2
pm2 start src/app.js --name jun-an-fou
pm2 save
pm2 startup
```

---

**配置说明文档结束**
