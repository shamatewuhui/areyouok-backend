# 君安否微信小程序 - 数据库设计文档

## 一、项目概述

**项目名称**：君安否  
**项目类型**：微信小程序  
**数据库类型**：MySQL 5.7+ / MySQL 8.0+

**核心功能**：
- 用户每日签到功能
- 连续两天未签到自动发送邮件提醒

## 二、数据库设计

### 2.1 数据库命名

```
数据库名：jun_an_fou
```

### 2.2 表结构设计

#### 2.2.1 用户表（T_USER）

存储用户基本信息，包括微信openid和邮箱信息。

| 字段名 | 类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| ID | bigint(20) | - | NOT NULL | - | 主键，自增 |
| OPENID | varchar(64) | 64 | NOT NULL | - | 微信用户openid，唯一标识 |
| NICKNAME | varchar(64) | 64 | NULL | NULL | 微信昵称 |
| AVATAR_URL | varchar(512) | 512 | NULL | NULL | 微信头像URL |
| EMAIL | varchar(128) | 128 | NOT NULL | - | 用户邮箱（用于接收提醒邮件） |
| EMAIL_VERIFIED | bit(1) | 1 | NOT NULL | b'0' | 邮箱是否已验证 |
| LAST_SIGN_TIME | datetime | - | NULL | NULL | 最后一次签到时间 |
| CONTINUOUS_DAYS | int(11) | - | NOT NULL | 0 | 连续签到天数 |
| TOTAL_SIGN_DAYS | int(11) | - | NOT NULL | 0 | 累计签到天数 |
| STATUS | tinyint(4) | 4 | NOT NULL | 1 | 用户状态：1-正常，0-禁用 |
| DELETE_FLAG | bit(1) | 1 | NOT NULL | b'0' | 删除标记：0-未删除，1-已删除 |
| CREATE_TIME | datetime | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| UPDATE_TIME | datetime | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
```sql
PRIMARY KEY (`ID`),
UNIQUE KEY `uni_inx_openid` (`OPENID`),
KEY `idx_email` (`EMAIL`),
KEY `idx_status` (`STATUS`, `DELETE_FLAG`),
KEY `idx_last_sign_time` (`LAST_SIGN_TIME`)
```

**建表SQL**：
```sql
CREATE TABLE IF NOT EXISTS `T_USER` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `OPENID` varchar(64) NOT NULL COMMENT '微信用户openid',
  `NICKNAME` varchar(64) DEFAULT NULL COMMENT '微信昵称',
  `AVATAR_URL` varchar(512) DEFAULT NULL COMMENT '微信头像URL',
  `EMAIL` varchar(128) NOT NULL COMMENT '用户邮箱',
  `EMAIL_VERIFIED` bit(1) NOT NULL DEFAULT b'0' COMMENT '邮箱是否已验证',
  `LAST_SIGN_TIME` datetime DEFAULT NULL COMMENT '最后一次签到时间',
  `CONTINUOUS_DAYS` int(11) NOT NULL DEFAULT 0 COMMENT '连续签到天数',
  `TOTAL_SIGN_DAYS` int(11) NOT NULL DEFAULT 0 COMMENT '累计签到天数',
  `STATUS` tinyint(4) NOT NULL DEFAULT 1 COMMENT '用户状态：1-正常，0-禁用',
  `DELETE_FLAG` bit(1) NOT NULL DEFAULT b'0' COMMENT '删除标记：0-未删除，1-已删除',
  `CREATE_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `UPDATE_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`ID`),
  UNIQUE KEY `uni_inx_openid` (`OPENID`),
  KEY `idx_email` (`EMAIL`),
  KEY `idx_status` (`STATUS`, `DELETE_FLAG`),
  KEY `idx_last_sign_time` (`LAST_SIGN_TIME`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

---

#### 2.2.2 签到记录表（T_SIGN_RECORD）

记录用户每天的签到情况，用于统计和判断连续签到。

| 字段名 | 类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| ID | bigint(20) | - | NOT NULL | - | 主键，自增 |
| USER_ID | bigint(20) | - | NOT NULL | - | 用户ID，外键关联T_USER.ID |
| SIGN_DATE | date | - | NOT NULL | - | 签到日期（YYYY-MM-DD） |
| SIGN_TIME | datetime | - | NOT NULL | CURRENT_TIMESTAMP | 签到时间（精确到秒） |
| CREATE_TIME | datetime | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
```sql
PRIMARY KEY (`ID`),
UNIQUE KEY `uni_inx_user_date` (`USER_ID`, `SIGN_DATE`),
KEY `idx_user_id` (`USER_ID`),
KEY `idx_sign_date` (`SIGN_DATE`)
```

**建表SQL**：
```sql
CREATE TABLE IF NOT EXISTS `T_SIGN_RECORD` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `USER_ID` bigint(20) NOT NULL COMMENT '用户ID',
  `SIGN_DATE` date NOT NULL COMMENT '签到日期',
  `SIGN_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '签到时间',
  `CREATE_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`ID`),
  UNIQUE KEY `uni_inx_user_date` (`USER_ID`, `SIGN_DATE`),
  KEY `idx_user_id` (`USER_ID`),
  KEY `idx_sign_date` (`SIGN_DATE`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='签到记录表';
```

---

#### 2.2.3 邮件通知记录表（T_EMAIL_NOTIFY）

记录已发送的邮件通知，避免重复发送，同时可用于通知历史查询。

| 字段名 | 类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| ID | bigint(20) | - | NOT NULL | - | 主键，自增 |
| USER_ID | bigint(20) | - | NOT NULL | - | 用户ID，外键关联T_USER.ID |
| EMAIL | varchar(128) | 128 | NOT NULL | - | 接收邮箱 |
| NOTIFY_TYPE | tinyint(4) | 4 | NOT NULL | 1 | 通知类型：1-连续两天未签到提醒 |
| NOTIFY_DATE | date | - | NOT NULL | - | 通知日期（对应未签到的日期） |
| NOTIFY_TIME | datetime | - | NOT NULL | CURRENT_TIMESTAMP | 通知发送时间 |
| SEND_STATUS | tinyint(4) | 4 | NOT NULL | 0 | 发送状态：0-待发送，1-发送成功，2-发送失败 |
| ERROR_MSG | varchar(512) | 512 | NULL | NULL | 发送失败时的错误信息 |
| CREATE_TIME | datetime | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
```sql
PRIMARY KEY (`ID`),
KEY `idx_user_id` (`USER_ID`),
KEY `idx_notify_date` (`NOTIFY_DATE`),
KEY `idx_send_status` (`SEND_STATUS`),
KEY `idx_user_notify_date` (`USER_ID`, `NOTIFY_DATE`, `NOTIFY_TYPE`)
```

**建表SQL**：
```sql
CREATE TABLE IF NOT EXISTS `T_EMAIL_NOTIFY` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `USER_ID` bigint(20) NOT NULL COMMENT '用户ID',
  `EMAIL` varchar(128) NOT NULL COMMENT '接收邮箱',
  `NOTIFY_TYPE` tinyint(4) NOT NULL DEFAULT 1 COMMENT '通知类型：1-连续两天未签到提醒',
  `NOTIFY_DATE` date NOT NULL COMMENT '通知日期',
  `NOTIFY_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '通知发送时间',
  `SEND_STATUS` tinyint(4) NOT NULL DEFAULT 0 COMMENT '发送状态：0-待发送，1-发送成功，2-发送失败',
  `ERROR_MSG` varchar(512) DEFAULT NULL COMMENT '发送失败时的错误信息',
  `CREATE_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`ID`),
  KEY `idx_user_id` (`USER_ID`),
  KEY `idx_notify_date` (`NOTIFY_DATE`),
  KEY `idx_send_status` (`SEND_STATUS`),
  KEY `idx_user_notify_date` (`USER_ID`, `NOTIFY_DATE`, `NOTIFY_TYPE`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='邮件通知记录表';
```

---

## 三、核心业务逻辑说明

### 3.1 签到逻辑

1. **签到判断**：
   - 用户每天只能签到一次（通过 `uni_inx_user_date` 唯一索引保证）
   - 签到时记录签到日期和签到时间

2. **连续签到计算**：
   - 查询用户最近一次签到日期
   - 如果最近一次签到是昨天，则连续签到天数+1
   - 如果最近一次签到不是昨天，则连续签到天数重置为1
   - 更新 `T_USER` 表的 `LAST_SIGN_TIME`、`CONTINUOUS_DAYS`、`TOTAL_SIGN_DAYS`

### 3.2 邮件提醒逻辑

1. **未签到判断**：
   - 查询用户最近一次签到日期
   - 如果最近一次签到日期 < 当前日期 - 1天（即至少连续两天未签到），则触发邮件提醒

2. **防重复发送**：
   - 通过 `T_EMAIL_NOTIFY` 表记录已发送的通知
   - 查询时检查是否已对同一日期发送过通知（`NOTIFY_TYPE = 1` 且 `NOTIFY_DATE` 相同）
   - 避免对同一未签到日期重复发送邮件

3. **定时任务**：
   - 建议使用定时任务（如每天凌晨1点）扫描所有用户
   - 检查连续两天未签到的用户
   - 发送邮件提醒并记录到 `T_EMAIL_NOTIFY` 表

---

## 四、常用查询SQL

### 4.1 用户签到

```sql
-- 用户签到（插入签到记录）
INSERT INTO T_SIGN_RECORD (USER_ID, SIGN_DATE, SIGN_TIME)
VALUES (?, CURDATE(), NOW())
ON DUPLICATE KEY UPDATE SIGN_TIME = NOW();

-- 更新用户签到统计
UPDATE T_USER 
SET LAST_SIGN_TIME = NOW(),
    CONTINUOUS_DAYS = CASE 
        WHEN DATE(LAST_SIGN_TIME) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) 
        THEN CONTINUOUS_DAYS + 1 
        ELSE 1 
    END,
    TOTAL_SIGN_DAYS = TOTAL_SIGN_DAYS + 1
WHERE ID = ?;
```

### 4.2 查询用户签到记录

```sql
-- 查询用户最近30天的签到记录
SELECT SIGN_DATE, SIGN_TIME 
FROM T_SIGN_RECORD 
WHERE USER_ID = ? 
  AND SIGN_DATE >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
ORDER BY SIGN_DATE DESC;

-- 查询用户连续签到天数
SELECT CONTINUOUS_DAYS 
FROM T_USER 
WHERE ID = ?;
```

### 4.3 查询需要发送邮件提醒的用户

```sql
-- 查询连续两天未签到的用户（用于定时任务）
SELECT u.ID, u.OPENID, u.EMAIL, u.LAST_SIGN_TIME
FROM T_USER u
WHERE u.STATUS = 1 
  AND u.DELETE_FLAG = 0
  AND u.EMAIL_VERIFIED = 1
  AND (
    u.LAST_SIGN_TIME IS NULL 
    OR DATE(u.LAST_SIGN_TIME) < DATE_SUB(CURDATE(), INTERVAL 1 DAY)
  )
  AND NOT EXISTS (
    SELECT 1 
    FROM T_EMAIL_NOTIFY en 
    WHERE en.USER_ID = u.ID 
      AND en.NOTIFY_TYPE = 1 
      AND en.NOTIFY_DATE = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
      AND en.SEND_STATUS = 1
  );
```

### 4.4 记录邮件通知

```sql
-- 插入邮件通知记录
INSERT INTO T_EMAIL_NOTIFY (USER_ID, EMAIL, NOTIFY_TYPE, NOTIFY_DATE, SEND_STATUS)
VALUES (?, ?, 1, DATE_SUB(CURDATE(), INTERVAL 1 DAY), 1);

-- 更新邮件发送状态
UPDATE T_EMAIL_NOTIFY 
SET SEND_STATUS = ?, 
    ERROR_MSG = ?,
    NOTIFY_TIME = NOW()
WHERE ID = ?;
```

---

## 五、数据库初始化脚本

### 5.1 创建数据库

```sql
CREATE DATABASE IF NOT EXISTS `jun_an_fou` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE `jun_an_fou`;
```

### 5.2 完整建表脚本

见上述各表的建表SQL，汇总如下：

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS `jun_an_fou` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE `jun_an_fou`;

-- 用户表
CREATE TABLE IF NOT EXISTS `T_USER` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `OPENID` varchar(64) NOT NULL COMMENT '微信用户openid',
  `NICKNAME` varchar(64) DEFAULT NULL COMMENT '微信昵称',
  `AVATAR_URL` varchar(512) DEFAULT NULL COMMENT '微信头像URL',
  `EMAIL` varchar(128) NOT NULL COMMENT '用户邮箱',
  `EMAIL_VERIFIED` bit(1) NOT NULL DEFAULT b'0' COMMENT '邮箱是否已验证',
  `LAST_SIGN_TIME` datetime DEFAULT NULL COMMENT '最后一次签到时间',
  `CONTINUOUS_DAYS` int(11) NOT NULL DEFAULT 0 COMMENT '连续签到天数',
  `TOTAL_SIGN_DAYS` int(11) NOT NULL DEFAULT 0 COMMENT '累计签到天数',
  `STATUS` tinyint(4) NOT NULL DEFAULT 1 COMMENT '用户状态：1-正常，0-禁用',
  `DELETE_FLAG` bit(1) NOT NULL DEFAULT b'0' COMMENT '删除标记：0-未删除，1-已删除',
  `CREATE_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `UPDATE_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`ID`),
  UNIQUE KEY `uni_inx_openid` (`OPENID`),
  KEY `idx_email` (`EMAIL`),
  KEY `idx_status` (`STATUS`, `DELETE_FLAG`),
  KEY `idx_last_sign_time` (`LAST_SIGN_TIME`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- 签到记录表
CREATE TABLE IF NOT EXISTS `T_SIGN_RECORD` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `USER_ID` bigint(20) NOT NULL COMMENT '用户ID',
  `SIGN_DATE` date NOT NULL COMMENT '签到日期',
  `SIGN_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '签到时间',
  `CREATE_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`ID`),
  UNIQUE KEY `uni_inx_user_date` (`USER_ID`, `SIGN_DATE`),
  KEY `idx_user_id` (`USER_ID`),
  KEY `idx_sign_date` (`SIGN_DATE`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='签到记录表';

-- 邮件通知记录表
CREATE TABLE IF NOT EXISTS `T_EMAIL_NOTIFY` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `USER_ID` bigint(20) NOT NULL COMMENT '用户ID',
  `EMAIL` varchar(128) NOT NULL COMMENT '接收邮箱',
  `NOTIFY_TYPE` tinyint(4) NOT NULL DEFAULT 1 COMMENT '通知类型：1-连续两天未签到提醒',
  `NOTIFY_DATE` date NOT NULL COMMENT '通知日期',
  `NOTIFY_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '通知发送时间',
  `SEND_STATUS` tinyint(4) NOT NULL DEFAULT 0 COMMENT '发送状态：0-待发送，1-发送成功，2-发送失败',
  `ERROR_MSG` varchar(512) DEFAULT NULL COMMENT '发送失败时的错误信息',
  `CREATE_TIME` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`ID`),
  KEY `idx_user_id` (`USER_ID`),
  KEY `idx_notify_date` (`NOTIFY_DATE`),
  KEY `idx_send_status` (`SEND_STATUS`),
  KEY `idx_user_notify_date` (`USER_ID`, `NOTIFY_DATE`, `NOTIFY_TYPE`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='邮件通知记录表';
```

---

## 六、数据字典

### 6.1 用户状态（T_USER.STATUS）

| 值 | 说明 |
|----|------|
| 1 | 正常 |
| 0 | 禁用 |

### 6.2 邮件通知类型（T_EMAIL_NOTIFY.NOTIFY_TYPE）

| 值 | 说明 |
|----|------|
| 1 | 连续两天未签到提醒 |

### 6.3 邮件发送状态（T_EMAIL_NOTIFY.SEND_STATUS）

| 值 | 说明 |
|----|------|
| 0 | 待发送 |
| 1 | 发送成功 |
| 2 | 发送失败 |

---

## 七、性能优化建议

1. **索引优化**：
   - 已为常用查询字段建立索引
   - `T_SIGN_RECORD` 表的 `uni_inx_user_date` 唯一索引保证每天只能签到一次
   - `T_EMAIL_NOTIFY` 表的复合索引 `idx_user_notify_date` 优化防重复查询

2. **数据归档**：
   - 建议定期归档历史签到记录（如保留最近1年的数据）
   - 归档历史邮件通知记录（如保留最近6个月的数据）

3. **查询优化**：
   - 签到查询使用日期范围限制，避免全表扫描
   - 定时任务查询未签到用户时，使用索引字段进行过滤

4. **扩展性考虑**：
   - 如果用户量较大，可以考虑按 `USER_ID` 进行分表
   - 邮件通知记录表可以考虑按时间分表

---

## 八、注意事项

1. **时区问题**：所有日期时间字段建议使用服务器时区，签到日期使用 `CURDATE()` 获取当前日期
2. **并发控制**：签到操作建议使用数据库事务或分布式锁，避免并发签到导致数据不一致
3. **邮件发送**：建议使用消息队列异步发送邮件，避免阻塞主流程
4. **数据备份**：定期备份数据库，建议每天备份一次
5. **监控告警**：监控数据库性能指标，如慢查询、连接数等

---

## 九、版本记录

| 版本 | 日期 | 说明 | 作者 |
|------|------|------|------|
| v1.0 | 2026-02-03 | 初始版本，完成基础表结构设计 | - |
